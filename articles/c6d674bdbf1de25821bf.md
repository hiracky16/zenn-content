---
title: "BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ IAM ãƒ­ãƒ¼ãƒ«ã‚’ç®¡ç†ã‚’æ¥½ã«ã™ã‚‹ Terraform Module ã‚’ä½œã‚Šã¾ã—ãŸ"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["bigquery", "google cloud"]
published: false
---

# æ¦‚è¦
GCP ã® BigQuery ã¯ã€å¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿åˆ†æã‚’è¡Œã†ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ã—ã‹ã—ã€è¤‡é›‘ãª IAM ãƒãƒªã‚·ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ã®ã¯éª¨ã®æŠ˜ã‚Œã‚‹ä½œæ¥­ã§ã™ã€‚
Terraform ã‚’ä½¿ã†ã“ã¨ã§ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°ã—ãç«‹ã¡ä¸Šã’ã‚‹ãŸã³ã«è¨­å®šã—ç›´ã™ã®ãŒåœ°å‘³ã«é¢å€’ã§ã™ã€‚

ãã“ã§ BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ IAM ãƒ­ãƒ¼ãƒ«ã‚’æ¯”è¼ƒçš„ç°¡å˜ã«ç®¡ç†ã§ãã‚‹ Terraform ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œã£ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚
ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã„å›ã™ã“ã¨ã§è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ IAM ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

# bigquery-dataset-member ã®ç´¹ä»‹

https://registry.terraform.io/modules/hiracky16/bigquery-dataset-member/google/latest

ã“ã® module ã§ã¯ BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å¯¾ã™ã‚‹ IAM ãƒ­ãƒ¼ãƒ«ã‚’åŒ…æ‹¬çš„ã«ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦è¤‡æ•°ã® IAM ãƒ­ãƒ¼ãƒ«ã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’ä¸€æ‹¬ã§è¨­å®šã§ãã¾ã™ã€‚
ãƒ­ãƒ¼ãƒ«ã¯ 3 ç¨®é¡ã§ã€`roles/bigquery.dataViewer`, `roles/bigquery.dataEditor`, `roles/bigquery.dataOwner` ã®ã©ã‚Œã‹ã§ã™ã€‚

ã¾ãŸæ›¸ããƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹ `roles/bigquery.user` ãŒä»˜ä¸ã•ã‚Œã‚‹ãŸã‚ã€BigQuery ã‚’ã™ãã«å®Ÿè¡Œã§ãã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

# ä½¿ç”¨ä¾‹
ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚
å…¥åŠ›ã«ã¯ Google Cloud ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ãã‚Œã«å¯¾ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’ json é…åˆ—ã§è¨˜è¿°ã—ã¾ã™ã€‚
ãƒ­ãƒ¼ãƒ«ã«ã¯ä¸Šè¨˜ã§ç´¹ä»‹ã—ãŸ 3 ã¤ä»¥å¤–ãŒå…¥åŠ›ã•ã‚Œã‚‹ã¨ validation ã§è½ã¨ã™ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚
ï¼ˆ`member` ã‚‚ `user:` ãªã©ã‹ã‚‰å§‹ã¾ã£ã¦ã„ãªã„ã¨ plan ã§å¤±æ•—ã—ã¾ã™ã€‚ï¼‰

```tf
module "bigquery_dataset_member" {
  source  = "hiracky16/bigquery-dataset-member/google"
  project = "projectA"
  datasets = [
    {
      id : "datasetA",
      members : [
        {
          member : "user:user-test@gmail.com",
          role : "roles/bigquery.dataEditor"
        },
        {
          member : "group:group-test@gmail.com",
          role : "roles/bigquery.dataOwner"
        }
      ]
    },
    {
      id : "datasetB",
      members : [
        {
          member : "serviceAccount:sa-test@projectA.iam.gserviceaccount.com",
          role : "roles/bigquery.dataViewer"
        }
      ]
    }
  ]
}
```

åœ°å‘³ã« Terraform ã§äºŒé‡ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿç¾ã•ã›ã‚‹ã®ãŒé›£ã—ã‹ã£ãŸã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ x ãƒ¡ãƒ³ãƒãƒ¼ã€ãƒ­ãƒ¼ãƒ«ã¨ãªã£ã¦ã„ã‚‹ãƒªã‚¹ãƒˆã‚’ flatten ã«ã—ã¦ãƒ«ãƒ¼ãƒ—ã‚’å›ã—ã¾ã—ãŸã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚ï¼ˆGitHub ã§ã‚‚è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼‰

```
locals {
  flatten_dataset_members = flatten([
    for dataset in var.datasets : [
      for member in dataset.members : {
        dataset_id : dataset.id,
        member : member.member,
        role : member.role
      }
    ]
  ])
}

resource "google_bigquery_dataset_iam_member" "bigquery_dataset_members" {
  for_each   = { for d in local.flatten_dataset_members : "${d.dataset_id}-${d.member}-${d.role}" => d }
  dataset_id = data.google_bigquery_dataset.datasets[each.value.dataset_id].dataset_id
  role       = each.value.role
  member     = each.value.member
}
```

# ã¾ã¨ã‚
ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å¯¾ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’ json é…åˆ—ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ãŒã€ã“ã‚ŒãŒå€‹äººçš„ã«è¦–èªæ€§ã«å„ªã‚Œã¦ã„ã‚‹ã¨æ€ã£ã¦ã„ã¦æ°—ã«å…¥ã£ã¦ã„ã¾ã™ã€‚
ã•ã‚‰ã«è©³ã—ã„æƒ…å ±ã‚„æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ GitHub ãƒªãƒã‚¸ãƒˆãƒªã§ã‚‚å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
https://github.com/hiracky16/terraform-google-bigquery-dataset-member
ã‚³ãƒ¡ãƒ³ãƒˆã‚„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼
