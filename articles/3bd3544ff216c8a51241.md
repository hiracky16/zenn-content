---
title: "Cloud Workflows で途中実行を実現"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Cloud Workflows", "GoogleCloud"]
published: false
---

# はじめに
Cloud Workflows は Google Cloud 製品の API を呼び出す順序関係を解決してくれるワークフロー製品です。
特徴としてはサーバレスで従量課金なところです。
Airflow などのサーバありきのワークフローエンジンとは違いサーバの管理が不要なので柔軟に扱うことができます。  
また従量課金でもあるため使用頻度の低いバッチ処理であれば無料枠に収まり経済的です。

そんな便利な Cloud Workflows ですがステップ中の途中から実行ができないくて不便です。

# 愚直に書いてみる

Cloud Workflows で処理順序を記述するとこのようになる。

```
main:
  steps:
    - callA:
        call: http.get
        args:
          url: https://example1.com
    - callB:
        call: http.get
        args:
          url: https://example2.com
    - callC:
        call: http.get
        args:
          url: https://example2.com
```

例えばこのワークフローの実行で `callB` が失敗してしまった場合があったとします。  
この場合 Cloud Workflows で再実行すると `callA` からの実行になってしまうが、場合によっては `callB` から実行したい場合もあります。  
愚直に書くとすると次のステップを引数で与えて、`next` で飛ばす方法が思いつきます。  
以下のように書き直し、実行時の引数に `{ "next": "callB" }` と記述すると `callB` まで処理を飛ばします。

```
main:
  params: [args]
  steps:
    - init:
        assign:
          - next: ${default(map.get(args, "next"), "callA")}
    - switch_next_step:
        switch:
          - condition: ${next == "callA"}
            next: callA
          - condition: ${next == "callB"}
            next: callB
          - condition: ${next == "callC"}
            next: callC
    - callA:
        call: http.get
        args:
          url: https://example.com
    - callB:
        call: http.get
        args:
          url: https://examplexxx.com
    - callC:
        call: http.get
        args:
          url: https://example1.com
```

# 自動で判別

Cloud Workflows の API を用いて直前の実行結果を取得して次に実行すべきステップを判別してみます。  
例として先程と同じで `callB` が失敗したとして、再実行時は `callB` から実行開始したいケースを考えます。  
以下のように API から実行結果を取得する部分を `get_next` というサブワークフローのように記述します。  
返り値として前回実行で失敗した場合に失敗したステップを返します。  

```
main:
  steps:
    - check_next:
        call: get_next
        result: get_next_result
    - assign_next:
        assign:
          - next: ${get_next_result}
    - switch_next_step:
        switch:
          - condition: ${next == "callA"}
            next: callA
          - condition: ${next == "callB"}
            next: callB
          - condition: ${next == "callC"}
            next: callC
    - callA:
        call: http.get
        args:
          url: https://example1.com
    - callB:
        call: http.get
        args:
          url: https://examplexxx.com
    - callC:
        call: http.get
        args:
          url: https://exampleyyy.com

get_next:
  steps:
    - list:
        call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.list
        args:
          parent: projects/xxxxxxxxxxxxxxx/locations/us-central1/workflows/workflow-test
          pageSize: 2 # 再実行と直前の実行の記録を取得する
          view: FULL
        result: list_result
    - detail:
        call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.get
        args:
          name: ${list_result.executions[1].name} # 直前の実行である 1 番目を取得
          view: FULL
        result: detail_result
    - check_state:
        switch:
          - condition: ${detail_result.state == "SUCCESS"}
            next: done
        next: get_failed
    - get_failed:
        return: ${detail_result.status.currentSteps[0].step}
    - done:
        return: "callA"
```

# まとめ

現状 Cloud Workflows では再実行時の途中実行を気軽にできないので手で実装してあげる必要があります。  
手動で行う場合は `switch` を使って愚直に `next` を指定していくやり方があります。  
更に前回実行を考慮して再実行したい場合は API 経由で実行結果を取得する方法があります。  
