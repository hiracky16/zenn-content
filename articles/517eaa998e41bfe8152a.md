---
title: "dataform-osmosis ã§ Dataform ã® SQLX ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç°¡å˜ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["google cloud", "Dataform"]
published: false
---

## Dataform Osmosis ã¨ã¯ï¼Ÿ

`dataform-osmosis` ã¯ã€Dataform ã§ç®¡ç†ã™ã‚‹ SQLX ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŠ¹ç‡çš„ã«æ•´ç†ãƒ»æ•´å‚™ã™ã‚‹ãŸã‚ã® CLI ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã§ã€BigQuery ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã¨ SQLX ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

Dataform ç•Œéšˆã§ã¯ã€`dbt-osmosis` ã®ã‚ˆã†ãªä¾¿åˆ©ãªã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ãŒã¾ã æ•´ã£ã¦ãŠã‚‰ãšã€Dataform ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŠ¹ç‡çš„ã« SQLX ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãã“ã§ã€å¿…è¦ãªãƒ„ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°ä½œã‚‹ã—ã‹ãªã„ã¨è€ƒãˆã€`dataform-osmosis` ã‚’é–‹ç™ºã—ã¾ã—ãŸã€‚

Dataform ã®ãŠä¸–è©±ã«ãªã£ã¦ã„ã‚‹è‡ªåˆ†ãŒã€ä½•ã‹æ©è¿”ã—ã¨ã—ã¦è²¢çŒ®ã§ããªã„ã‹ã¨è€ƒãˆã€Dataform ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å½¹ç«‹ã¤ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

https://github.com/hiracky16/dataform-osmosis

### ä¸»ãªæ©Ÿèƒ½

- **BigQuery ã®ã‚«ãƒ©ãƒ æƒ…å ±ã®åŒæœŸ**ï¼šSQLX ãƒ•ã‚¡ã‚¤ãƒ«ã« BigQuery ã®ã‚«ãƒ©ãƒ æƒ…å ±ã‚’è‡ªå‹•çš„ã«è¿½åŠ 
- **ã‚«ãƒ©ãƒ èª¬æ˜ã®ç¶™æ‰¿**ï¼šå‚ç…§å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰åŒã˜ã‚«ãƒ©ãƒ åã®èª¬æ˜ã‚’ç¶™æ‰¿ã—ã€èª¬æ˜ä¸è¶³ã‚’è£œå®Œ

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

`dataform-osmosis` ã¯ npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```bash
npm install -g dataform-osmosis
```

## ä½¿ã„æ–¹
### Dataform ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¤œè¨¼
Dataform ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã‚’æ¤œè¨¼ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```bash
dataform-osmosis valid
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€BigQuery ã®è¨­å®šã‚’ç¢ºèªã—ã€Dataform CLI ãŒæ­£ã—ãã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### SQLX ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
SQLX ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ©ãƒ æƒ…å ±ã‚’æ›´æ–°ã—ã¦æ•´åˆ—ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```bash
dataform-osmosis refactor -f [file_or_directory]
```

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã« table1 ã«ä¾å­˜ã™ã‚‹ table2 ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚
`table2.sqlx` ã«ã¯ `columns` ãŒå®šç¾©ã—ã¦ãŠã‚‰ãšã‚«ãƒ©ãƒ ã®èª¬æ˜ã‚„ãƒãƒªã‚·ãƒ¼ã‚¿ã‚°ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

```sql:table1.sqlx
config {
    type: "table",
    "columns": {
        id: "id",
        name: {
          description: "name",
          bigqueryPolicyTags: ["projects/example-project/locations/us/taxonomies/123456789/policyTags/123456789"]
        }
    }
}
SELECT id,
    name
FROM ${ref('table0')}
```

```sql:table2.sqlx
config {
    type: "table"
}
SELECT *
FROM ${ref('table1')}
```

ã“ã®çŠ¶æ…‹ã§ dataform-osmosis ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `table1.sqlx` ã®èª¬æ˜ã‚„ãƒãƒªã‚·ãƒ¼ã‚¿ã‚°ã‚’ `table2.sqlx` ãŒå¼•ãç¶™ãã“ã¨ãŒã§ãã¾ã™ã€‚

```
> dataform-osmosis sqlx refactor -f definitions/
ğŸ“ Refactoring definitions/table1.sqlx
ğŸ“ Refactoring definitions/table2.sqlx
ğŸ”ï¸ Loading Dataform Project...
ğŸ”ï¸ Compiling Dataform Project...
ğŸ”ï¸ Loading BigQuery tables in dataform...
ğŸ”„ Refactoring definitions/table1.sqlx...
ğŸ”¨ Updated SQLX file: definitions/table1.sqlx
âœ…ï¸ Refactored definitions/table1.sqlx
ğŸ”„ Refactoring definitions/table2.sqlx...
ğŸ”¨ Updated SQLX file: definitions/table2.sqlx
âœ…ï¸ Refactored definitions/table2.sqlx
```

```sql:table2.sqlx
config {
  "type": "table",
  "columns": {
    "id": {
      "description": "id"
    },
    "name": {
      "description": "name",
      "bigqueryPolicyTags": [
        "projects/example-project/locations/us/taxonomies/123456789/policyTags/123456789"
      ]
    }
  }
}
SELECT *
FROM ${ref('table1')}
```


## è¨­å®šæ–¹æ³•
dataform-osmosis ã§ã¯ã€BigQuery ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ workflow_settings.yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€šã˜ã¦è¨­å®šã§ãã¾ã™ã€‚

```yaml
defaultProject: your-project-id
defaultLocation: asia-northeast1
defaultDataset: dataform
defaultAssertionDataset: dataform_assertions
```

## ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼
Dataform ã‚’ãŠä½¿ã„ã®çš†æ§˜ã«ã¨ã£ã¦ã€dataform-osmosis ãŒ SQLX ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã®åŠ¹ç‡åŒ–ã«å½¹ç«‹ã¤ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚ãœã²ä½¿ã£ã¦ã¿ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ï¼

ä»Šå¾Œã‚‚æ©Ÿèƒ½è¿½åŠ ã‚„æ”¹å–„ã‚’è¡Œã£ã¦ã„ãäºˆå®šã§ã™ã®ã§ã€æ°—è»½ã« Issue ã‚„ PR ã§ã®ã”å”åŠ›ã‚‚ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ï¼

https://github.com/hiracky16/dataform-osmosis
